@using System.Text.RegularExpressions
@using System.Web.Security
@model WebApplication.Models.Model.Blog
@{
    ViewBag.Title = "Yazı";
    Layout = "~/Views/Shared/_SiteLayout.cshtml";
}

<section id="content">
    <div class="container">

        <div class="row">
            <div class="col-lg-8">
                <article>
                    <div class="post-image">
                        <img src="@Model.CoverURL"
                            alt="@Html.Raw(Regex.Replace(Model.Title ?? "", "<.*?>", String.Empty))" />
                    </div>

                    <div class="bottom-article">
                        <ul class="meta-post">
                            <li>
                                <i class="fas fa-calendar"></i>@{
                                // Güncellenme tarihi varsa onu, yoksa oluşturulma tarihini göster
                                var displayDate = Model.UpdatedAt.HasValue ? Model.UpdatedAt.Value : Model.CreatedAt;
                                                                }
                                <span>@displayDate.ToString("dd MMMM yyyy, HH.mm", new
                                                                        System.Globalization.CultureInfo("tr-TR"))</span>
                            </li>
                            <li><i class="fas fa-user"></i><a href="/Home/BlogbyAuthor/@Model.AuthorId"> @Model.Author.Name </a></li>
                            <li><i class="fas fa-folder-open"></i><a href="/Home/BlogbyCategory/@Model.CategoryId"> @Model.Category.CategoryName </a></li>
                        </ul>
                    </div>

                    <div class="post-heading">
                        <h3>@Html.Raw(Regex.Replace(Model.Title ?? "", "<.*?>", String.Empty))</h3>
                    </div>
                    <p>
                        @Html.Raw(Regex.Replace(Model.Text ?? "", "<.*?>", String.Empty))
                    </p>
                </article>

                <div class="row">
                    <div class="col-lg-12">
                        <h4>Yorumlar</h4>
                        @{
                            // Yorum listesini PartialView ile yükle
                            Html.RenderAction("CommentList", "Home", new { blogId = Model.BlogId });
                        }
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <h4>Yorumunuzu Girin!</h4>

                        @if (TempData["Message"] != null)
                        {
                            <div class="alert alert-info">
                                @TempData["Message"]
                            </div>
                        }

                        @if (User.Identity.IsAuthenticated && Session["Admin"] != null)
                        {
                            using (Html.BeginForm("AddComment", "Home", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("blogId", Model.BlogId)
                                <div class="form-group">
                                    <textarea style="width:100%;" name="CommentText" rows="5" placeholder="Bir yorum girin..."
                                required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Yorum Ekle
                                </button>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Yorum yapmak için giriş yapmanız gerekmektedir.</strong><br>
                                <a href="@Url.Action("Login", "Admin", new { returnUrl = Request.Url.PathAndQuery })"
                                    class="btn btn-primary mt-2">
                                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                                </a>
                                <a href="@Url.Action("Signup", "Admin")" class="btn btn-outline-primary mt-2">
                                    <i class="fas fa-user-plus"></i> Kayıt Ol
                                </a>
                            </div>
                        }
                    </div>
                </div>

            </div>

            <div class="col-lg-4">
                <aside class="right-sidebar">
                    <div class="widget">
                        <form method="get" action="@Url.Action("Search", "Home")" class="form-search">
                            <input name="query" class="form-control" type="text" placeholder="Search..">
                            <button type="submit" class="btn btn-primary mt-2">Ara</button>
                        </form>
                    </div>
                    <div class="widget">
                        <h5 class="widgetheading">Kategoriler</h5>
                        @*Kategori Listesi*@
                        @{
                            Html.RenderAction("PartialCategory", "Home");
                        }
                    </div>
                    <div class="widget">
                        <h5 class="widgetheading">Benzer Yazılar</h5>
                        @*Benzer Post Listesi*@
                        @{
                            Html.RenderAction("SimilarPostPartial", "Home", new
                            {
                                currentPostId = Model.BlogId,
                                categoryId =
                            Model.CategoryId
                            });
                        }
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>